services:
  # -------------------------
  # Reverse proxy / Web (Nginx)
  # -------------------------
  nginx:
    image: nginx:1.27-alpine
    container_name: emk_nginx
    depends_on:
      - laravel
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"  # si luego montas TLS acá
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # Si sirves assets desde Laravel, puedes montar un volumen compartido (opcional)
      # - laravel_public:/var/www/public:ro
    networks:
      - emk_net
    restart: unless-stopped

  # -------------------------
  # Laravel (PHP-FPM)
  # -------------------------
  laravel:
    image: "ghcr.io/emksas/emk-laravel:${LARAVEL_TAG:-develop-latest}"
    container_name: emk_laravel
    env_file:
      - ./.env
    environment:
      APP_ENV: "${APP_ENV:-production}"
      # Si tu Laravel necesita saber dónde está Spring:
      SPRING_BASE_URL: "http://spring:8080"
    networks:
      - emk_net
    restart: unless-stopped

  # -------------------------
  # Spring Boot
  # -------------------------
  spring:
    image: "ghcr.io/emksas/financial-planning:${SPRING_TAG:-develop-latest}"
    container_name: emk_spring
    env_file:
      - ./.env
    environment:
      SPRING_PROFILES_ACTIVE: "${SPRING_PROFILES_ACTIVE:-prod}"
      # Ejemplo si usa DB:
      # SPRING_DATASOURCE_URL: "${SPRING_DATASOURCE_URL}"
      # SPRING_DATASOURCE_USERNAME: "${SPRING_DATASOURCE_USERNAME}"
      # SPRING_DATASOURCE_PASSWORD: "${SPRING_DATASOURCE_PASSWORD}"
    ports:
      - "${SPRING_HOST_PORT:-8082}:8080"
    networks:
      - emk_net
    restart: unless-stopped

  # -------------------------
  # Node (opcional)
  # -------------------------
  node:
    image: "ghcr.io/emksas/emk-node:${NODE_TAG:-develop-latest}"
    container_name: emk_node
    env_file:
      - ./.env
    ports:
      - "${NODE_HOST_PORT:-3000}:3000"
    networks:
      - emk_net
    restart: unless-stopped
    profiles: ["node"]  # para prenderlo solo cuando quieras: docker compose --profile node up -d


networks:
  emk_net:
    driver: bridge

volumes:
  laravel_public:  # si decides compartir public con nginx